var M={implied:(k)=>{return(w)=>{return k(w)}},immediate:(k)=>{return(w)=>{let A=byte(w);return k(w,A)}},absolute:(k)=>{return(w)=>{let A=address(w);return k(w,A)}},zeropage:(k)=>{return(w)=>{let A=byte(w);return k(w,A)}},zeropageX:(k)=>{return(w)=>{let A=byte(w),D=w.registers[Register.X];return k(w,A+D&255)}},zeropageY:(k)=>{return(w)=>{let A=byte(w),D=w.registers[Register.Y];return k(w,A+D&255)}},absoluteX:(k)=>{return(w)=>{let A=address(w),D=w.registers[Register.X];return k(w,A+D&65535)}},absoluteY:(k)=>{return(w)=>{let A=address(w),D=w.registers[Register.Y];return k(w,A+D&65535)}},xIndexedIndirect:(k)=>{return(w)=>{let A=byte(w),D=w.registers[Register.X],h=w.memory[A+D&255],z=w.memory[A+D+1&255];return k(w,h|z<<8)}},indirectYIndexed:(k)=>{return(w)=>{let A=byte(w),D=w.memory[A&255],h=w.memory[A+1&255],z=w.registers[Register.Y];return k(w,(D|h<<8)+z)}},relative:(k)=>{return(w)=>{let A=byte(w),D=w.pc+A&65535;return k(w,D)}}},j={BRK:(k)=>{k.halt=!0},NOP:(k)=>{},ASL:(k)=>{let A=k.registers[Register.A]<<1,D=A&255;k.registers[Register.A]=D,flag.set(k,StatusFlag.N,(D&128)!==0),flag.set(k,StatusFlag.Z,D===0),flag.set(k,StatusFlag.C,A!==D)}},E={JMP:(k,w)=>{k.pc=w}},q={ADC:(k,w)=>{let A=k.registers[Register.A],D=flag.get(k,StatusFlag.C)?1:0,h=A+w+D;k.registers[Register.A]=h&255,flag.set(k,StatusFlag.N,(h&128)!==0),flag.set(k,StatusFlag.Z,h===0),flag.set(k,StatusFlag.C,h>255),flag.set(k,StatusFlag.V,h>255)},AND:(k,w)=>{let A=k.registers[Register.A];k.registers[Register.A]=A&w,flag.set(k,StatusFlag.N,(k.registers[Register.A]&128)!==0),flag.set(k,StatusFlag.Z,k.registers[Register.A]===0)},ASL:(k,w)=>{let A=w<<1,D=A&255;return flag.set(k,StatusFlag.N,(D&128)!==0),flag.set(k,StatusFlag.Z,D===0),flag.set(k,StatusFlag.C,A!==D),D},BCC:(k,w)=>{if(!flag.get(k,StatusFlag.C))k.pc=w},BCS:(k,w)=>{if(flag.get(k,StatusFlag.C))k.pc=w},LDA:(k,w)=>{k.registers[Register.A]=w,flag.set(k,StatusFlag.N,(k.registers[Register.A]&128)!==0),flag.set(k,StatusFlag.Z,k.registers[Register.A]===0)},LDX:(k,w)=>{k.registers[Register.X]=w,flag.set(k,StatusFlag.N,(k.registers[Register.X]&128)!==0),flag.set(k,StatusFlag.Z,k.registers[Register.X]===0)},LDY:(k,w)=>{k.registers[Register.Y]=w,flag.set(k,StatusFlag.N,(k.registers[Register.Y]&128)!==0),flag.set(k,StatusFlag.Z,k.registers[Register.Y]===0)},STA:(k,w)=>{let A=k.registers[Register.A];k.memory[A]=w},STX:(k,w)=>{let A=k.registers[Register.X];k.memory[A]=w},STY:(k,w)=>{let A=k.registers[Register.Y];k.memory[A]=w}},K=[[0,"BRK",M.implied(j.BRK)],[6,"ASL",M.zeropage(q.ASL)],[10,"ASL",M.implied(j.ASL)],[14,"ASL",M.absolute(q.ASL)],[22,"ASL",M.zeropageX(q.ASL)],[30,"ASL",M.absoluteX(q.ASL)],[33,"AND",M.xIndexedIndirect(q.AND)],[37,"AND",M.zeropage(q.AND)],[41,"AND",M.immediate(q.AND)],[45,"AND",M.absolute(q.AND)],[49,"AND",M.indirectYIndexed(q.AND)],[53,"AND",M.zeropageX(q.AND)],[57,"AND",M.absoluteY(q.AND)],[61,"AND",M.absoluteX(q.AND)],[76,"JMP",M.absolute(E.JMP)],[76,"JMP",M.relative(j.JMP)],[97,"ADC",M.xIndexedIndirect(q.ADC)],[101,"ADC",M.zeropage(q.ADC)],[105,"ADC",M.immediate(q.ADC)],[108,"JMP",M.absolute(E.JMP)],[109,"ADC",M.absolute(q.ADC)],[113,"ADC",M.indirectYIndexed(q.ADC)],[117,"ADC",M.zeropageX(q.ADC)],[121,"ADC",M.absoluteY(q.ADC)],[125,"ADC",M.absoluteX(q.ADC)],[129,"STA",M.xIndexedIndirect(q.STA)],[132,"STY",M.zeropage(q.STY)],[133,"STA",M.implied(j.STA)],[134,"STX",M.zeropage(q.STX)],[140,"STY",M.absolute(q.STY)],[141,"STA",M.absolute(q.STA)],[142,"STX",M.absolute(q.STX)],[144,"BCC",M.relative(j.BCC)],[145,"STA",M.indirectYIndexed(q.STA)],[148,"STY",M.zeropageX(q.STY)],[150,"STX",M.zeropageY(q.STX)],[153,"STA",M.absoluteY(q.STA)],[157,"STA",M.absoluteX(q.STA)],[160,"LDY",M.immediate(q.LDY)],[161,"LDA",M.xIndexedIndirect(q.LDA)],[162,"LDX",M.immediate(q.LDX)],[164,"LDY",M.zeropage(q.LDY)],[165,"LDA",M.zeropage(q.LDA)],[166,"LDX",M.zeropage(q.LDX)],[169,"LDA",M.immediate(q.LDA)],[172,"LDY",M.absolute(q.LDY)],[173,"LDA",M.absolute(q.LDA)],[174,"LDX",M.absolute(q.LDX)],[177,"LDA",M.indirectYIndexed(q.LDA)],[180,"LDY",M.zeropageX(q.LDY)],[181,"LDA",M.zeropageX(q.LDA)],[182,"LDX",M.zeropageY(q.LDX)],[185,"LDA",M.absoluteY(q.LDA)],[188,"LDY",M.absoluteX(q.LDY)],[189,"LDA",M.absoluteX(q.LDA)],[190,"LDX",M.absoluteY(q.LDX)],[234,"NOP",M.implied(j.NOP)]],H=new Map,L=new Map,G=new Map;for(let[k,w,A]of K){let D=G.get(w)??[];G.set(w,[...D,k]),L.set(k,w),H.set(k,A)}class B{freq;cpu;now;delta;opsPerTick=0;get halt(){return this.cpu.halt}set halt(k){this.cpu.halt=k}constructor(k={}){this.freq=k.freq??1e6,this.now=performance.now(),this.delta=100,this.cpu={halt:!0,memory:new Uint8Array(k.memory??65536),registers:new Uint8Array(8),pc:0,sp:0}}reset(){this.halt=!0,this.cpu.pc=0,this.cpu.sp=511,this.cpu.registers.fill(0),this.cpu.memory.fill(0),this.cpu.memory[0]=234,this.cpu.memory[1]=76,this.cpu.memory[2]=0,this.cpu.memory[3]=0,this.cpu.memory[4093]=0,this.cpu.memory[4094]=1,this.cpu.memory[4095]=0;for(let k=0;k<4096;k++)this.cpu.memory[4096+k]="Hello world.".charCodeAt(k)||48}resume(){this.halt=!1,this.now=performance.now()}tick(){this.opsPerTick=Math.floor(this.freq/60);for(let k=0;k<this.opsPerTick;k++){if(this.halt)break;let w=byte(this.cpu),A=H.get(w);if(A)A(this.cpu)}}}var y=new B;onmessage=(k)=>{if(!k.data)return;let{type:w}=k.data;if(w=="start")y.reset(),postMessage({type:"tick",cpu:y.cpu}),y.resume()};var F={now:performance.now(),deltas:[0],tick:30},I=()=>{let k=performance.now();if(y.tick(),F.tick++,F.deltas.push(k-F.now),F.now=k,F.deltas.length>60)F.deltas.shift();if(postMessage({type:"tick",cpu:y.cpu}),F.tick>60){let w=F.deltas.reduce((A,D)=>A+D,0)/F.deltas.length*60/1000;postMessage({type:"state",state:{delta:w.toFixed(3),halt:y.halt}}),F.tick=0}return requestAnimationFrame(I)};I();
