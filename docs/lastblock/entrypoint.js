var A=new Map,U={get:(F)=>{let J=F.startsWith("--")?F:`--${F}`;if(A.has(J))return A.get(J);let K=getComputedStyle(document.documentElement).getPropertyValue(J).trim();if(!K)return console.warn(`CSS variable ${J} not found or empty`),"#000000";return A.set(J,K),K},set:(F,J)=>{let K=F.startsWith("--")?F:`--${F}`;if(A.get(K)!==J)document.documentElement.style.setProperty(K,J),A.set(K,J)},clearCache:()=>{A.clear()},hexToRgb:(F)=>{if(F=F.replace(/^#/,""),F.length===3)F=F.split("").map((K)=>K+K).join("");let J=parseInt(F,16);return{r:J>>16&255,g:J>>8&255,b:J&255}},lightenColor:(F,J)=>{let K=F.replace("#",""),Q=parseInt(K.substr(0,2),16),Z=parseInt(K.substr(2,2),16),_=parseInt(K.substr(4,2),16),j=Math.min(Math.floor(Q*(1+J/100)),255),q=Math.min(Math.floor(Z*(1+J/100)),255),V=Math.min(Math.floor(_*(1+J/100)),255);return`rgb(${j}, ${q}, ${V})`},darkenColor:(F,J)=>{let K=F.replace("#",""),Q=parseInt(K.substr(0,2),16),Z=parseInt(K.substr(2,2),16),_=parseInt(K.substr(4,2),16),j=Math.max(Math.floor(Q*(1-J/100)),0),q=Math.max(Math.floor(Z*(1-J/100)),0),V=Math.max(Math.floor(_*(1-J/100)),0);return`rgb(${j}, ${q}, ${V})`},isLightColor:(F)=>{let J=F.replace("#",""),K=parseInt(J.substr(0,2),16),Q=parseInt(J.substr(2,2),16),Z=parseInt(J.substr(4,2),16);return(K*299+Q*587+Z*114)/1000>125}};var $={gridSize:10,cellSize:40,get colors(){return[U.get("color-teal"),U.get("color-light-brown")]},get highlightColor(){return U.get("highlight-color")},get invalidColor(){return U.get("invalid-color")},pieceAreaHeight:150,pieceSize:80,pieceMargin:20,maxAvailablePieces:3,gameOverButton:{width:200,height:60,get color(){return U.get("button-background")},get hoverColor(){return U.get("button-hover")},get textColor(){return U.get("button-text")},font:"20px Arial",text:"Play Again"},get backgroundColor(){return U.get("background-color")},get gridLineColor(){return U.get("grid-line-color")},get textColor(){return U.get("text-color")},get borderColor(){return U.get("border-color")}};class D{name;color;pattern;constructor(F,J,K){this.name=F,this.pattern=J,this.color=K}static shapes=[new D("Line",[[!0,!0,!0,!0]],"#3D8C9E"),new D("LineVertical",[[!0],[!0],[!0],[!0]],"#3D8C9E"),new D("Square2x2",[[!0,!0],[!0,!0]],"#D4AF91"),new D("Square3x3",[[!0,!0,!0],[!0,!0,!0],[!0,!0,!0]],"#D4AF91"),new D("TShape",[[!1,!0,!1],[!0,!0,!0]],"#9370DB"),new D("TShapeFlipped",[[!0,!0,!0],[!1,!0,!1]],"#9370DB"),new D("TShapeRight",[[!1,!0],[!0,!0],[!1,!0]],"#9370DB"),new D("TShapeLeft",[[!0,!1],[!0,!0],[!0,!1]],"#9370DB"),new D("LShape",[[!0,!1],[!0,!1],[!0,!0]],"#CD7F32"),new D("LShapeRight",[[!0,!0,!0],[!0,!1,!1]],"#CD7F32"),new D("LShapeUpside",[[!0,!0],[!1,!0],[!1,!0]],"#CD7F32"),new D("LShapeLeft",[[!1,!1,!0],[!0,!0,!0]],"#CD7F32"),new D("ZShape",[[!0,!0,!1],[!1,!0,!0]],"#B22222"),new D("ZShapeReflected",[[!1,!0,!0],[!0,!0,!1]],"#B22222"),new D("ZShapeVertical",[[!1,!0],[!0,!0],[!0,!1]],"#B22222"),new D("ZShapeVerticalReflected",[[!0,!1],[!0,!0],[!1,!0]],"#B22222"),new D("SmallL",[[!0,!1],[!0,!0]],"#6B8E23"),new D("SmallLRight",[[!0,!0],[!0,!1]],"#6B8E23"),new D("SmallLUpside",[[!0,!0],[!1,!0]],"#6B8E23"),new D("SmallLLeft",[[!1,!0],[!0,!0]],"#6B8E23"),new D("Single",[[!0]],"#4682B4")];static all(){return[...this.shapes]}static random(){return this.shapes[Math.floor(Math.random()*this.shapes.length)]}static byName(F){return this.shapes.find((J)=>J.name===F)}static randomPattern(){return this.random().pattern}}class R{shape;color;x;y;isAvailable;shapeName;constructor(F,J,K){if(this.x=0,this.y=0,this.isAvailable=!0,F)this.shape=F,this.shapeName="custom",this.color=K||$.colors[Math.floor(Math.random()*$.colors.length)];else{let Q=D.random();this.shape=Q.pattern,this.shapeName=Q.name,this.color=Q.color}if(J!==void 0){let Q=$.gridSize*$.cellSize,Z=this.shape[0].length*$.cellSize,_=Q/$.maxAvailablePieces;this.x=_/2-Z/2+J*_;let j=$.gridSize*$.cellSize,q=this.shape.length*$.cellSize;this.y=j+$.pieceAreaHeight/2-q/2}}generateRandomShape(){return D.randomPattern()}contains(F,J){let K=$.cellSize,Q=this.x,Z=this.x+this.shape[0].length*K,_=this.y,j=this.y+this.shape.length*K;if(F>=Q&&F<Z&&J>=_&&J<j){let q=Math.floor((F-this.x)/K),V=Math.floor((J-this.y)/K);if(q>=0&&q<this.shape[0].length&&V>=0&&V<this.shape.length)return this.shape[V][q]}return!1}render(F){let J=$.cellSize;for(let K=0;K<this.shape.length;K++)for(let Q=0;Q<this.shape[K].length;Q++)if(this.shape[K][Q]){let Z=this.x+Q*J,_=this.y+K*J;this.drawBlockWithEffect(F,Z,_,J)}}drawBlockWithEffect(F,J,K,Q){F.fillStyle=this.color,F.fillRect(J,K,Q,Q),F.fillStyle=this.lightenColor(this.color,15),F.beginPath(),F.moveTo(J,K),F.lineTo(J+Q,K),F.lineTo(J+Q-4,K+4),F.lineTo(J+4,K+4),F.closePath(),F.fill(),F.fillStyle=this.darkenColor(this.color,15),F.beginPath(),F.moveTo(J+Q,K),F.lineTo(J+Q,K+Q),F.lineTo(J+Q-4,K+Q-4),F.lineTo(J+Q-4,K+4),F.closePath(),F.fill(),F.fillStyle=this.darkenColor(this.color,25),F.beginPath(),F.moveTo(J,K+Q),F.lineTo(J+Q,K+Q),F.lineTo(J+Q-4,K+Q-4),F.lineTo(J+4,K+Q-4),F.closePath(),F.fill(),F.fillStyle=this.lightenColor(this.color,5),F.beginPath(),F.moveTo(J,K),F.lineTo(J,K+Q),F.lineTo(J+4,K+Q-4),F.lineTo(J+4,K+4),F.closePath(),F.fill(),F.strokeStyle="#3F3A33",F.lineWidth=1,F.strokeRect(J,K,Q,Q),this.drawSymbolOnBlock(F,J,K,Q)}drawSymbolOnBlock(F,J,K,Q){let Z=Q*0.2,_=Q-Z*2,j=this.isLightColor(this.color);switch(F.fillStyle=j?this.darkenColor(this.color,30):this.lightenColor(this.color,30),F.strokeStyle=j?this.darkenColor(this.color,30):this.lightenColor(this.color,30),F.lineWidth=2,this.shapeName){case"Line":F.beginPath(),F.moveTo(J+Z,K+Q/2),F.lineTo(J+Q-Z,K+Q/2),F.stroke();break;case"Square2x2":F.strokeRect(J+Z,K+Z,_,_);break;case"TShape":F.beginPath(),F.moveTo(J+Q/2,K+Z),F.lineTo(J+Q/2,K+Q-Z),F.moveTo(J+Z,K+Z),F.lineTo(J+Q-Z,K+Z),F.stroke();break;case"LShape":F.beginPath(),F.moveTo(J+Z+_/3,K+Z),F.lineTo(J+Z+_/3,K+Q-Z),F.lineTo(J+Q-Z,K+Q-Z),F.stroke();break;case"ZShape":F.beginPath(),F.moveTo(J+Z,K+Z),F.lineTo(J+Q-Z,K+Z),F.lineTo(J+Z,K+Q-Z),F.lineTo(J+Q-Z,K+Q-Z),F.stroke();break;case"Single":F.beginPath(),F.arc(J+Q/2,K+Q/2,_/5,0,Math.PI*2),F.fill();break;case"SmallL":F.beginPath(),F.moveTo(J+Z+_/3,K+Z),F.lineTo(J+Z+_/3,K+Q-Z),F.lineTo(J+Q-Z,K+Q-Z),F.stroke();break;case"Square3x3":F.strokeRect(J+Z,K+Z,_,_),F.strokeRect(J+Z+_/4,K+Z+_/4,_/2,_/2);break;default:F.beginPath(),F.arc(J+Q/2,K+Q/2,_/3,0,Math.PI*2),F.stroke()}}lightenColor(F,J){let K=F.replace("#",""),Q=parseInt(K.substr(0,2),16),Z=parseInt(K.substr(2,2),16),_=parseInt(K.substr(4,2),16),j=Math.min(Math.floor(Q*(1+J/100)),255),q=Math.min(Math.floor(Z*(1+J/100)),255),V=Math.min(Math.floor(_*(1+J/100)),255);return`rgb(${j}, ${q}, ${V})`}darkenColor(F,J){let K=F.replace("#",""),Q=parseInt(K.substr(0,2),16),Z=parseInt(K.substr(2,2),16),_=parseInt(K.substr(4,2),16),j=Math.max(Math.floor(Q*(1-J/100)),0),q=Math.max(Math.floor(Z*(1-J/100)),0),V=Math.max(Math.floor(_*(1-J/100)),0);return`rgb(${j}, ${q}, ${V})`}isLightColor(F){let J=F.replace("#",""),K=parseInt(J.substr(0,2),16),Q=parseInt(J.substr(2,2),16),Z=parseInt(J.substr(4,2),16);return(K*299+Q*587+Z*114)/1000>125}}class N{cells;constructor(){this.reset()}reset(){this.cells=Array($.gridSize).fill(null).map(()=>Array($.gridSize).fill(null))}setCellState(F,J,K){if(F>=0&&F<$.gridSize&&J>=0&&J<$.gridSize)this.cells[J][F]=K}serialize(){return this.cells.map((F)=>F.map((J)=>J||""))}static deserialize(F){let J=new N,K=Math.min(F.length,$.gridSize);for(let Q=0;Q<K;Q++){let Z=F[Q],_=Math.min(Z.length,$.gridSize);for(let j=0;j<_;j++)J.cells[Q][j]=Z[j]||null}return J}isCellOccupied(F,J){if(F<0||J<0||F>=$.gridSize||J>=$.gridSize)return!0;return this.cells[J][F]!==null}clone(){let F=new N;return F.cells=this.cells.map((J)=>[...J]),F}}function G(F){let J=document.getElementById("score");if(J)J.textContent=F.toString()}function T(F,J){for(let K=0;K<J.length;K++)if(J[K].isAvailable)J[K].render(F)}function k(F,J){let Q=F.canvas.width,Z=$.gridSize*$.cellSize;F.fillStyle="rgba(0, 0, 0, 0.7)",F.fillRect(0,0,Q,Z+$.pieceAreaHeight),F.font="36px Arial",F.fillStyle="white",F.textAlign="center",F.textBaseline="middle",F.fillText("Game Over!",Q/2,Z/3),F.font="28px Arial",F.fillText(`Final Score: ${J}`,Q/2,Z/2)}function W(F,J){let Q=F.canvas.width,Z=$.gridSize*$.cellSize,_=$.gameOverButton,j=(Q-_.width)/2,q=Z*0.65;F.fillStyle=J?_.hoverColor:_.color,F.strokeStyle="rgba(0, 0, 0, 0.3)",F.lineWidth=2;let V=8;return F.beginPath(),F.moveTo(j+V,q),F.lineTo(j+_.width-V,q),F.quadraticCurveTo(j+_.width,q,j+_.width,q+V),F.lineTo(j+_.width,q+_.height-V),F.quadraticCurveTo(j+_.width,q+_.height,j+_.width-V,q+_.height),F.lineTo(j+V,q+_.height),F.quadraticCurveTo(j,q+_.height,j,q+_.height-V),F.lineTo(j,q+V),F.quadraticCurveTo(j,q,j+V,q),F.closePath(),F.fill(),F.stroke(),F.font=_.font,F.fillStyle=_.textColor,F.textAlign="center",F.textBaseline="middle",F.fillText(_.text,j+_.width/2,q+_.height/2),{x:j,y:q,width:_.width,height:_.height}}function H(F,J,K,Q,Z,_){return F>=K&&F<=K+Z&&J>=Q&&J<=Q+_}class I{canvas;ctx;board;score;constructor(F,J=0){this.canvas=F,this.ctx=F.getContext("2d"),this.score=J,this.board=new N,this.render()}render(){let F=this.ctx,J=$.cellSize,K=$.gridSize*J;F.fillStyle=$.backgroundColor,F.fillRect(0,0,this.canvas.width,this.canvas.height),F.strokeStyle=$.gridLineColor,F.lineWidth=1;for(let q=0;q<=$.gridSize;q++)F.beginPath(),F.moveTo(0,q*J),F.lineTo(this.canvas.width,q*J),F.stroke(),F.beginPath(),F.moveTo(q*J,0),F.lineTo(q*J,K),F.stroke();for(let q=0;q<$.gridSize;q++)for(let V=0;V<$.gridSize;V++){let L=this.board.cells[q][V];if(L){F.fillStyle=L,F.strokeStyle="#3F3A33",F.lineWidth=2;let O=V*J,M=q*J;F.fillRect(O,M,J,J),F.fillStyle=this.lightenColor(L,15),F.beginPath(),F.moveTo(O,M),F.lineTo(O+J,M),F.lineTo(O+J-4,M+4),F.lineTo(O+4,M+4),F.closePath(),F.fill(),F.fillStyle=this.darkenColor(L,15),F.beginPath(),F.moveTo(O+J,M),F.lineTo(O+J,M+J),F.lineTo(O+J-4,M+J-4),F.lineTo(O+J-4,M+4),F.closePath(),F.fill(),F.strokeRect(O,M,J,J)}}F.beginPath(),F.strokeStyle=$.borderColor,F.lineWidth=2,F.moveTo(0,K),F.lineTo(this.canvas.width,K),F.stroke();let Q=K+20,Z="Available Pieces";F.font="16px Arial",F.textAlign="center",F.fillStyle="rgba(30, 28, 25, 0.7)";let _=F.measureText(Z).width+10,j=20;F.fillRect(this.canvas.width/2-_/2,Q-j+4,_,j),F.fillStyle=$.textColor,F.fillText(Z,this.canvas.width/2,Q)}lightenColor(F,J){let K=F.replace("#",""),Q=parseInt(K.substr(0,2),16),Z=parseInt(K.substr(2,2),16),_=parseInt(K.substr(4,2),16),j=Math.min(Math.floor(Q*(1+J/100)),255),q=Math.min(Math.floor(Z*(1+J/100)),255),V=Math.min(Math.floor(_*(1+J/100)),255);return`rgb(${j}, ${q}, ${V})`}darkenColor(F,J){let K=F.replace("#",""),Q=parseInt(K.substr(0,2),16),Z=parseInt(K.substr(2,2),16),_=parseInt(K.substr(4,2),16),j=Math.max(Math.floor(Q*(1-J/100)),0),q=Math.max(Math.floor(Z*(1-J/100)),0),V=Math.max(Math.floor(_*(1-J/100)),0);return`rgb(${j}, ${q}, ${V})`}canPlacePiece(F,J,K){for(let Q=0;Q<F.shape.length;Q++)for(let Z=0;Z<F.shape[Q].length;Z++)if(F.shape[Q][Z]){let _=J+Z,j=K+Q;if(_<0||_>=$.gridSize||j<0||j>=$.gridSize)return!1;if(this.board.cells[j][_]!==null)return!1}return!0}placePiece(F,J,K){if(!this.canPlacePiece(F,J,K))return!1;for(let Q=0;Q<F.shape.length;Q++)for(let Z=0;Z<F.shape[Q].length;Z++)if(F.shape[Q][Z])this.board.cells[K+Q][J+Z]=F.color;return this.render(),this.checkForCompleteLines(),!0}highlightValidPlacement(F,J,K,Q){if(!F)return;let Z=$.cellSize,_=this.canPlacePiece(F,J,K);Q.globalAlpha=0.3,Q.fillStyle=_?$.highlightColor:$.invalidColor;for(let j=0;j<F.shape.length;j++)for(let q=0;q<F.shape[j].length;q++)if(F.shape[j][q]){let V=J*Z+q*Z,L=K*Z+j*Z;Q.fillRect(V,L,Z,Z)}Q.globalAlpha=1}checkForCompleteLines(){let F=0,J=new Set;for(let K=0;K<$.gridSize;K++)if(this.board.cells[K].every((Q)=>Q!==null)){for(let Q=0;Q<$.gridSize;Q++)J.add(`${K},${Q}`);F++}for(let K=0;K<$.gridSize;K++)if(this.board.cells.map((Z)=>Z[K]).every((Z)=>Z!==null)){for(let Z=0;Z<$.gridSize;Z++)J.add(`${Z},${K}`);F++}if(J.size>0){J.forEach((_)=>{let[j,q]=_.split(",").map(Number);this.board.cells[j][q]=null});let K=100,Q=F,Z=F>1?F:1;if(this.score+=K*F*Z,F>1)this.showMultiLineBonus(F);G(this.score),this.render()}return F}showMultiLineBonus(F){let J=this.ctx,K=$.gridSize*$.cellSize;J.save(),J.font="bold 24px Arial",J.fillStyle="#FFD700",J.textAlign="center",J.shadowColor="rgba(0,0,0,0.5)",J.shadowBlur=5;let Q=`${F}x MULTIPLIER!`;J.fillText(Q,this.canvas.width/2,K/2),J.restore()}setCellState(F,J,K){this.board.setCellState(F,J,K)}setBoard(F){this.board=F,this.render()}clearGrid(){this.board.reset(),this.render()}getBoard(){return this.board}}var E=(F)=>$.colors[F%$.colors.length],P={rowColClear:{name:"Row & Column Clear Test",description:"Test clearing both a row and column simultaneously",boardState:Array($.gridSize).fill("").map((F,J)=>Array($.gridSize).fill("").map((K,Q)=>{if(J===5&&Q!==5)return E(0);if(Q===5&&J!==5)return E(1);return""})),availablePieces:[{shape:[[!0]],color:E(0)}]},multiRowClear:{name:"Multi-Row Clear Test",description:"Test clearing multiple rows simultaneously",boardState:Array($.gridSize).fill("").map((F,J)=>Array($.gridSize).fill("").map((K,Q)=>{if(J===3&&Q<$.gridSize-1)return E(0);if(J===5&&Q<$.gridSize-1)return E(1);return""})),availablePieces:[{shape:[[!0],[!0]],color:E(0)}]},customPieces:{name:"Custom Test Pieces",description:"Empty board with custom test pieces",boardState:Array($.gridSize).fill("").map(()=>Array($.gridSize).fill("")),availablePieces:[{shape:[[!0]],color:E(0)},{shape:[[!0,!1],[!0,!0]],color:E(1)},{shape:[[!0,!0,!0],[!1,!0,!1]],color:E(0)}]},complexClears:{name:"Complex Clear Scenarios",description:"Complex test scenario with multiple potential line clears",boardState:Array($.gridSize).fill("").map((F,J)=>Array($.gridSize).fill("").map((K,Q)=>{if(J===2&&Q<$.gridSize-2)return E(0);if(J===5&&Q>0&&Q<$.gridSize-1)return E(1);if(Q===2&&J<$.gridSize-2)return E(1);if(Q===5&&J>0&&J<$.gridSize-1)return E(0);return""})),availablePieces:[{shape:[[!0,!0],[!0,!1]],color:E(0)},{shape:[[!0,!0],[!0,!0]],color:E(1)},{shape:[[!0,!0,!0]],color:E(0)}]}};class B{score=0;isDragging=!1;activePiece=null;dragStartX=0;dragStartY=0;dragCurrentX=0;dragCurrentY=0;animationFrameId=null;availablePieces=[];isGameOver=!1;finalScore=0;hoveringPlayButton=!1;grid;mainCanvas;overlayCanvas;mainCtx;overlayCtx;constructor(){this.mainCanvas=document.getElementById("main-canvas"),this.overlayCanvas=document.getElementById("overlay-canvas"),this.mainCtx=this.mainCanvas.getContext("2d"),this.overlayCtx=this.overlayCanvas.getContext("2d");let F=$.gridSize*$.cellSize+$.pieceAreaHeight;this.mainCanvas.width=$.gridSize*$.cellSize,this.mainCanvas.height=F,this.overlayCanvas.width=$.gridSize*$.cellSize,this.overlayCanvas.height=F,this.grid=new I(this.mainCanvas,this.score),this.setupEventListeners()}initialize(){this.generateInitialPieces(),T(this.overlayCtx,this.availablePieces)}setupEventListeners(){this.overlayCanvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.overlayCanvas.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),this.setupGameOverEvents(),document.getElementById("new-game-btn")?.addEventListener("click",this.newGame.bind(this))}generateInitialPieces(){for(let F=0;F<$.maxAvailablePieces;F++)this.generateNewPiece()}generateNewPiece(){for(let F=0;F<$.maxAvailablePieces;F++)if(!this.availablePieces[F]||!this.availablePieces[F].isAvailable){let J=new R(void 0,F);if(F<this.availablePieces.length)this.availablePieces[F]=J;else this.availablePieces.push(J);return}}animateDrag(){if(this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),T(this.overlayCtx,this.availablePieces),this.isDragging&&this.activePiece){let F=$.cellSize,J=this.dragCurrentX-this.dragStartX,K=this.dragCurrentY-this.dragStartY;this.activePiece.x+=J,this.activePiece.y+=K,this.dragStartX=this.dragCurrentX,this.dragStartY=this.dragCurrentY;let Q=this.activePiece.shape[0].length*F,Z=this.activePiece.shape.length*F,_=this.activePiece.x+Q/2,j=this.activePiece.y+Z/2,q=Math.floor(_/F),V=Math.floor(j/F),L=V<$.gridSize&&q<$.gridSize;if(this.activePiece.render(this.overlayCtx),L){let O=Math.floor(q-Math.floor(this.activePiece.shape[0].length/2)),M=Math.floor(V-Math.floor(this.activePiece.shape.length/2));this.grid.highlightValidPlacement(this.activePiece,O,M,this.overlayCtx)}this.animationFrameId=requestAnimationFrame(this.animateDrag.bind(this))}else if(this.animationFrameId!==null)cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null}findPieceAtPosition(F,J){for(let K=this.availablePieces.length-1;K>=0;K--){let Q=this.availablePieces[K];if(Q.isAvailable&&Q.contains(F,J))return Q}return null}tryPlacePiece(F,J){if(!this.activePiece)return;if(this.grid.placePiece(this.activePiece,F,J))this.activePiece.isAvailable=!1,this.score=this.grid.score,this.generateNewPiece(),this.checkGameOver();else this.repositionAvailablePieces()}repositionAvailablePieces(){for(let F=0;F<this.availablePieces.length;F++)if(this.availablePieces[F].isAvailable){let J=$.gridSize*$.cellSize,K=this.availablePieces[F].shape[0].length*$.cellSize,Q=this.availablePieces.filter((q)=>q.isAvailable).length,Z=J/$.maxAvailablePieces;this.availablePieces[F].x=Z/2-K/2+F*Z;let _=$.gridSize*$.cellSize,j=this.availablePieces[F].shape.length*$.cellSize;this.availablePieces[F].y=_+$.pieceAreaHeight/2-j/2}}checkGameOver(){let F=!1;for(let J of this.availablePieces){if(!J.isAvailable)continue;for(let K=0;K<$.gridSize;K++)for(let Q=0;Q<$.gridSize;Q++)if(this.grid.canPlacePiece(J,Q,K)){F=!0;return}}if(!F){if(this.isGameOver=!0,this.finalScore=this.score,k(this.mainCtx,this.finalScore),this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),W(this.overlayCtx,!1),this.animationFrameId!==null)cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null}}loadTestScenario(F){if(!P[F]){console.error(`Scenario "${F}" not found.`);return}this.grid.clearGrid(),this.score=0;let J=P[F],K=new N;J.boardState.forEach((Q,Z)=>{Q.forEach((_,j)=>{if(_)K.setCellState(j,Z,_)})}),this.grid.setBoard(K),this.availablePieces=[],J.availablePieces.forEach((Q,Z)=>{if(Z<$.maxAvailablePieces){let _=new R(Q.shape,Z);_.color=Q.color,this.availablePieces.push(_)}});while(this.availablePieces.length<$.maxAvailablePieces)this.generateNewPiece();this.grid.render(),this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),T(this.overlayCtx,this.availablePieces),G(this.score)}newGame(F){this.score=0,this.isGameOver=!1,document.getElementById("score").textContent="0",this.grid=new I(this.mainCanvas,this.score),this.availablePieces=[];for(let J=0;J<$.maxAvailablePieces;J++)this.generateNewPiece();if(F)this.loadTestScenario(F);else this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),T(this.overlayCtx,this.availablePieces)}setupGameOverEvents(){this.overlayCanvas.addEventListener("mousemove",(F)=>{if(!this.isGameOver)return;let J=this.overlayCanvas.getBoundingClientRect(),K=(F.clientX-J.left)*(this.overlayCanvas.width/J.width),Q=(F.clientY-J.top)*(this.overlayCanvas.height/J.height),Z=W(this.overlayCtx,!1),_=H(K,Q,Z.x,Z.y,Z.width,Z.height);if(_!==this.hoveringPlayButton)this.hoveringPlayButton=_,this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),W(this.overlayCtx,_)}),this.overlayCanvas.addEventListener("click",(F)=>{if(!this.isGameOver)return;let J=this.overlayCanvas.getBoundingClientRect(),K=(F.clientX-J.left)*(this.overlayCanvas.width/J.width),Q=(F.clientY-J.top)*(this.overlayCanvas.height/J.height),Z=W(this.overlayCtx,!1);if(H(K,Q,Z.x,Z.y,Z.width,Z.height))this.newGame()})}handleMouseDown(F){if(this.isGameOver)return;let J=this.overlayCanvas.getBoundingClientRect(),K=(F.clientX-J.left)*(this.overlayCanvas.width/J.width),Q=(F.clientY-J.top)*(this.overlayCanvas.height/J.height),Z=this.findPieceAtPosition(K,Q);if(Z){if(F.preventDefault(),this.activePiece=Z,this.isDragging=!0,this.dragStartX=K,this.dragStartY=Q,this.dragCurrentX=K,this.dragCurrentY=Q,this.animationFrameId===null)this.animationFrameId=requestAnimationFrame(this.animateDrag.bind(this));document.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.addEventListener("mouseup",this.handleMouseUp.bind(this))}}handleMouseMove(F){if(this.isDragging&&this.activePiece){let J=this.overlayCanvas.getBoundingClientRect();document.body.style.cursor="grabbing",this.dragCurrentX=(F.clientX-J.left)*(this.overlayCanvas.width/J.width),this.dragCurrentY=(F.clientY-J.top)*(this.overlayCanvas.height/J.height)}}handleMouseUp(F){if(this.isDragging&&this.activePiece){let J=$.cellSize,K=this.activePiece.shape[0].length*J,Q=this.activePiece.shape.length*J,Z=this.activePiece.x+K/2,_=this.activePiece.y+Q/2,j=Math.floor(Z/J),q=Math.floor(_/J),V=Math.floor(j-Math.floor(this.activePiece.shape[0].length/2)),L=Math.floor(q-Math.floor(this.activePiece.shape.length/2));if(q<$.gridSize&&j<$.gridSize)this.tryPlacePiece(V,L);else this.repositionAvailablePieces();document.body.style.cursor="default",this.isDragging=!1,this.activePiece=null,this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),T(this.overlayCtx,this.availablePieces),document.removeEventListener("mousemove",this.handleMouseMove.bind(this)),document.removeEventListener("mouseup",this.handleMouseUp.bind(this))}}handleTouchStart(F){if(F.touches.length>0){let J=this.overlayCanvas.getBoundingClientRect(),K=F.touches[0],Q=(K.clientX-J.left)*(this.overlayCanvas.width/J.width),Z=(K.clientY-J.top)*(this.overlayCanvas.height/J.height),_=this.findPieceAtPosition(Q,Z);if(_){if(F.preventDefault(),this.activePiece=_,this.isDragging=!0,this.dragStartX=Q,this.dragStartY=Z,this.dragCurrentX=Q,this.dragCurrentY=Z,this.animationFrameId===null)this.animationFrameId=requestAnimationFrame(this.animateDrag.bind(this));document.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),document.addEventListener("touchend",this.handleTouchEnd.bind(this))}}}handleTouchMove(F){if(F.touches.length>0&&this.isDragging&&this.activePiece){F.preventDefault();let J=F.touches[0],K=this.overlayCanvas.getBoundingClientRect();this.dragCurrentX=(J.clientX-K.left)*(this.overlayCanvas.width/K.width),this.dragCurrentY=(J.clientY-K.top)*(this.overlayCanvas.height/K.height)}}handleTouchEnd(F){if(this.isDragging&&this.activePiece){let J=$.cellSize,K=this.activePiece.shape[0].length*J,Q=this.activePiece.shape.length*J,Z=this.activePiece.x+K/2,_=this.activePiece.y+Q/2,j=Math.floor(Z/J),q=Math.floor(_/J),V=Math.floor(j-Math.floor(this.activePiece.shape[0].length/2)),L=Math.floor(q-Math.floor(this.activePiece.shape.length/2));if(q<$.gridSize&&j<$.gridSize)this.tryPlacePiece(V,L);else this.repositionAvailablePieces();this.isDragging=!1,this.activePiece=null,this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),T(this.overlayCtx,this.availablePieces),document.removeEventListener("touchmove",this.handleTouchMove.bind(this)),document.removeEventListener("touchend",this.handleTouchEnd.bind(this))}}}class w extends HTMLElement{selectEl;buttonEl;gameState;constructor(){super();this.attachShadow({mode:"open"});let F=document.createElement("div");F.className="test-scenarios-container",this.selectEl=document.createElement("select"),this.selectEl.id="test-scenario-select";let J=document.createElement("option");J.value="",J.textContent="Select a test scenario",this.selectEl.appendChild(J),Object.entries(P).forEach(([Q,Z])=>{let _=document.createElement("option");_.value=Q,_.textContent=Z.name,this.selectEl.appendChild(_)}),this.buttonEl=document.createElement("button"),this.buttonEl.id="load-scenario-btn",this.buttonEl.textContent="Load Scenario",this.buttonEl.addEventListener("click",this.handleLoadScenario.bind(this));let K=document.createElement("style");K.textContent=`
            .test-scenarios-container {
                display: flex;
                justify-content: center;
                align-items: center;
                margin: 10px 0;
                gap: 10px;
            }
            
            select {
                padding: 8px;
                border-radius: 4px;
                border: 1px solid #ccc;
                background-color: white;
                font-family: inherit;
                font-size: 14px;
            }
            
            button {
                padding: 8px 12px;
                background-color: var(--button-background, #BE9B7B);
                color: var(--button-text, #2A2723);
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
            }
            
            button:hover {
                background-color: var(--button-hover, #D4AF91);
            }
        `,F.appendChild(this.selectEl),F.appendChild(this.buttonEl),this.shadowRoot.appendChild(K),this.shadowRoot.appendChild(F)}setGameState(F){this.gameState=F}handleLoadScenario(){if(!this.gameState)return;let F=this.selectEl.value;if(F)this.gameState.newGame(F)}static isTestModeEnabled(){return new URLSearchParams(window.location.search).has("testmode")}}customElements.define("test-mode-ui",w);window.addEventListener("DOMContentLoaded",()=>{let F=new B;if(F.initialize(),w.isTestModeEnabled()){let J=document.getElementById("test-mode-container");if(J){let K=document.createElement("test-mode-ui");J.appendChild(K),K.setGameState(F)}}});
